echo "๐ ะัะพะฒะตััั USB-ะฟะพะดะบะปััะตะฝะธะต iPhone..."

USB_OK=$(system_profiler SPUSBDataType | grep -c "iPhone")

if [ "$USB_OK" -eq 0 ]; then
  echo "โ iPhone ะะ ะฝะฐะนะดะตะฝ ะฟะพ USB!"
  echo "โก ะัะพะฒะตัั ะบะฐะฑะตะปั ะธ ัะฒะตัะธัั, ััะพ Wireless Debugging ะพัะบะปัััะฝ"
  exit 1
fi

echo "โ iPhone ะฝะฐะนะดะตะฝ ะฟะพ USB"

echo "๐งน ะงะธัั ััะฐััะต ะฟัะพัะตััั..."
pkill -f uvicorn 2>/dev/null || true
pkill -f iproxy 2>/dev/null || true
pkill -f flutter_tools 2>/dev/null || true

echo "๐ ะะฐะฟััะบะฐั AI-ัะตัะฒะตั..."
source .venv/bin/activate
uvicorn iris_ai_server:app --host 0.0.0.0 --port 8010 --reload &
sleep 2

echo "๐ ะะฐะฟััะบะฐั iproxy..."
iproxy 8010 8010 &
sleep 2

echo "๐ฏ ะะพัะพะฒะพ! ะขะตะฟะตัั ะทะฐะฟัััะธ Flutter ะฒัััะฝัั:"
echo ""
echo "fvm flutter run -d $DEVICE_ID --dart-define=AI_ENDPOINT=$AI_URL"
echo ""
echo "๐ ะัะพััะพ ะฒััะฐะฒั ััั ะบะพะผะฐะฝะดั ะฒ ะดััะณะพะน ัะตัะผะธะฝะฐะป."
